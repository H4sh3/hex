<html>

<head>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="app">
        <h1>
            Create a short-url
        </h1>
        <div v-if="shortenedUrl">
            <span style="font-weight: bold;">
                {{shortenedUrl}}
            </span>
            will now redirect to:
            {{url}}
        </div>
        <div v-else>
            <form @submit.prevent="validateForm" method="post" novalidate="true">
                <p>
                    <label for="url">Url</label>
                    <input id="url" v-model="url" type="url" name="url" min="0">
                </p>
                <p>
                    <label for="slug">Slug</label>
                    <input id="slug" v-model="slug" type="slug" name="slug" placeholder="( not required )">
                </p>
                <p>
                    <input type="submit" value="Submit">
                </p>
                <p v-if="errors.length">
                    <b>Please correct the following error(s):</b>
                <ul>
                    <li v-for="error in errors">{{ error }}</li>
                </ul>
                </p>
            </form>
        </div>
    </div>
    <script src="https://unpkg.com/vue"></script>
    <script>
        new Vue({
            el: '#app',
            data: {
                errors: [],
                url: null,
                slug: "",
                shortenedUrl: null
            },
            methods: {
                validateForm(e) {
                    this.errors = [];

                    if (!this.url) {
                        this.errors.push('Enter url to shorten!');
                    } else if (!this.validUrl(this.url)) {
                        this.errors.push('Invalid url!');
                    }
                    if (this.slug && !this.validSlug(this.slug)) {
                        this.errors.push('Invalid slug! only letters and numbers allowed');
                    }
                    if (!this.errors.length) {
                        this.submitNewUrl()
                    }
                },
                async submitNewUrl() {
                    const response = await fetch('/url', {
                        method: 'POST',
                        headers: {
                            'content-type': 'application/json'
                        },
                        body: JSON.stringify({
                            'url': this.url,
                            'slug': this.slug
                        }),
                    })
                    this.created = await response.json()
                    if (this.created["message"]) {
                        this.errors.push(this.created["message"]);
                    } else {
                        this.shortenedUrl = 'https://' + document.domain + '/' + this.created["slug"]
                    }
                },
                validUrl(url) {
                    const re = RegExp('(https?:\\/\\/)?((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|((\\d{1,3}\\.){3}\\d{1,3}))(\\:\\d+)?(\\/[-a-z\\d%_.~+@]*)*(\\?[;&a-z\\d%_.~+=-@]*)?(\\#[-a-z\\d_@]*)?$', 'i');
                    return url.match(re);
                },
                validSlug(slug) {
                    const re = RegExp(/^[\w]+$/);
                    return slug.match(re);
                }
            }
        })
    </script>
</body>

</html>